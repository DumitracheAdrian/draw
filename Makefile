help:
	@echo "This makefile is intended mainly for development purpose."
	@echo ""
	@echo "Targets:"
	@echo "    install:   This will setup the development environment"
	@echo "    up:        docker-compose up the development environment"
	@echo "    down:      docker-compose down the development environment"
	@echo "    test:      run all the vendor/bin/phpunit"
	@echo "    workspace: connect via bash to the workspace container"
	@echo "    clear:     clear all data generated by the build process, this include the database"
	@echo "    provision: provision the data, this should be executed after a clear"
	@echo "    test:          run all the test via vendor/bin/phpunit"
	@echo "    test-coverage: run all the test with html code coverage report"

.ONESHELL:
down:
	if [ -d laradock-draw ]; then
		cd laradock-draw && docker-compose down
	fi

up:
	cd laradock-draw && docker-compose up -d workspace

test:
	cd laradock-draw && docker-compose exec --user=laradock workspace vendor/bin/phpunit

workspace:
	cd laradock-draw && docker-compose exec --user=laradock workspace bash

install: clear setup build provision

setup:
	git clone --branch v5.9.0 https://github.com/laradock/laradock.git laradock-draw
	cp laradock.env-dist laradock-draw/.env

build:
	cd laradock-draw && docker-compose build workspace

clear: down
	sudo rm -Rf ./tmp
	sudo rm -Rf ./laradock-draw
	sudo rm -Rf ./vendor

provision: up
	cd laradock-draw && docker-compose exec --user=laradock workspace composer install

test:
	cd laradock-draw && docker-compose exec --user=laradock workspace vendor/bin/phpunit

test-coverage:
	cd laradock-draw && docker-compose exec --user=laradock workspace vendor/bin/phpunit --coverage-html ./tmp/phpunit/report

subsplit:
	rm -rf .subsplit
	git subsplit init https://github.com/mpoiriert/draw
	git subsplit publish " \
	    src/DataTester:https://github.com/mpoiriert/php-data-tester.git \
	    src/HttpTester:https://github.com/mpoiriert/php-http-tester.git \
	"
	rm -rf .subsplit